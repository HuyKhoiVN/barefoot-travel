@{
    ViewData["Title"] = "Homepage Content Management";
    Layout = "~/Views/Admin/_Layout.cshtml";
}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-md-flex align-items-center mb-4">
                    <div>
                        <h4 class="card-title">Homepage Content Management</h4>
                        <p class="card-subtitle">Manage how categories and tours are displayed on the homepage</p>
                    </div>
                    <div class="ms-auto mt-3 mt-md-0">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSectionModal">
                            <i class="ti ti-plus me-2"></i>Configure New Section
                        </button>
                    </div>
                </div>

                <!-- Active Sections List -->
                <div class="alert alert-info mb-4">
                    <i class="ti ti-info-circle me-2"></i>
                    <strong>How it works:</strong> Configure which categories appear on the homepage. Each section can display tours from selected categories with custom titles and layout styles.
                </div>

                <!-- Configured Sections -->
                <div id="homepageSectionsList" class="row">
                    <!-- Sections will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add/Edit Homepage Section -->
<div class="modal fade" id="addSectionModal" tabindex="-1" aria-labelledby="addSectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSectionModalLabel">Configure Homepage Section</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="sectionForm">
                    <input type="hidden" id="sectionId">
                    <input type="hidden" id="categoryId">
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Section Title (Displayed on Homepage) <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="sectionTitle" placeholder="e.g., Ways to Travel, Top Packages" required>
                            <small class="text-muted">This title will be shown as the section heading on the homepage</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Select Category <span class="text-danger">*</span></label>
                            <input type="hidden" id="categorySelect" required>
                            <div id="categoryTree" class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto; overflow-x: hidden;">
                                <div class="text-center text-muted">Loading categories...</div>
                            </div>
                            <small class="text-muted">Tours from this category will be displayed (Only TOURS type)</small>
                        </div>
                        <div class="col-md-6 mb-3 position-relative">
                            <label class="form-label">Layout Style</label>
                            <select class="form-select" id="layoutStyle">
                                <option value="grid">Grid (4 columns)</option>
                                <option value="grid-3">Grid (3 columns)</option>
                                <option value="grid-2">Grid (2 columns)</option>
                                <option value="spotlight">Spotlight (Large cards)</option>
                                <option value="carousel">Carousel</option>
                            </select>
                            <!-- Layout Demo Tooltip -->
                            <div id="layoutDemo" class="layout-demo-tooltip" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 5px; z-index: 1050; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 15px; min-width: 350px; max-width: 500px;">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <h6 class="mb-0" id="demoTitle">Layout Preview</h6>
                                    <button type="button" class="btn-close" onclick="$('#layoutDemo').hide();"></button>
                                </div>
                                <div id="demoContent" style="font-size: 12px;">
                                    <!-- Demo content will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Max Items to Display</label>
                            <input type="number" class="form-control" id="maxItems" value="8" min="1" max="20">
                            <small class="text-muted">Maximum number of tours to show</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Display Order</label>
                            <input type="number" class="form-control" id="displayOrder" value="0">
                            <small class="text-muted">Order on homepage (0 = first)</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="isActive">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Section Badge Text (Optional)</label>
                        <input type="text" class="form-control" id="badgeText" placeholder="e.g., FEATURED, NEW, BEST SELLER">
                        <small class="text-muted">This text will appear as a badge on the section</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Custom CSS Class (Optional)</label>
                        <input type="text" class="form-control" id="customClass" placeholder="e.g., special-section, dark-theme">
                        <small class="text-muted">Add custom styling to this section</small>
                    </div>

                    <!-- Spotlight Image (only for Spotlight layout) -->
                    <div class="mb-3" id="spotlightImageContainer" style="display: none;">
                        <label class="form-label">Spotlight Background Image <span class="text-danger">*</span></label>
                        <div class="row">
                            <div class="col-md-6">
                                <div id="spotlightImagePreview" class="mb-2" style="display: none;">
                                    <img id="spotlightImagePreviewImg" src="" alt="Preview" class="img-thumbnail" style="max-height: 200px;">
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openSpotlightImageGallery()">
                                    <i class="ti ti-photo me-1"></i>Select Image
                                </button>
                                <input type="hidden" id="spotlightImageUrl">
                            </div>
                        </div>
                        <small class="text-muted d-block mt-2">This image will be used as the background for the spotlight card (Required for Spotlight layout)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSectionBtn">Save Section</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Preview Section -->
<div class="modal fade" id="previewSectionModal" tabindex="-1" aria-labelledby="previewSectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewSectionModalLabel">Section Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="sectionPreview">
                    <!-- Preview will be shown here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Delete Confirmation -->
<div class="modal fade" id="deleteSectionModal" tabindex="-1" aria-labelledby="deleteSectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteSectionModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <i class="ti ti-alert-circle fs-1 text-danger"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Are you sure you want to remove this section?</h6>
                        <p class="text-muted mb-0" id="deleteSectionInfo">This action cannot be undone.</p>
                    </div>
                </div>
                <div class="alert alert-warning">
                    <i class="ti ti-info-circle me-2"></i>
                    <strong>Note:</strong> This will only remove the section from the homepage. Tours and categories will not be affected.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="ti ti-trash me-2"></i>Delete Section
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Reorder Sections -->
<div class="modal fade" id="reorderSectionsModal" tabindex="-1" aria-labelledby="reorderSectionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reorderSectionsModalLabel">Reorder Homepage Sections</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="ti ti-info-circle me-2"></i>
                    Drag and drop sections to reorder them, or use the arrow buttons.
                </div>
                <div id="reorderSectionsList" class="list-group">
                    <!-- Sections will be loaded here for reordering -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveReorderBtn">
                    <i class="ti ti-check me-2"></i>Save Order
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ways to Travel Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-md-flex align-items-center mb-4">
                    <div>
                        <h4 class="card-title">Ways to Travel</h4>
                        <p class="card-subtitle">Configure travel style categories displayed on the homepage</p>
                    </div>
                    <div class="ms-auto mt-3 mt-md-0">
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#waysToTravelModal">
                            <i class="ti ti-plus me-2"></i>Add Category to Ways to Travel
                        </button>
                    </div>
                </div>

                <!-- Alert Info -->
                <div class="alert alert-warning mb-4">
                    <i class="ti ti-alert-circle me-2"></i>
                    <strong>Requirements:</strong> Maximum 5 categories allowed. Each category must have at least 1 image (max 2 images). Categories are displayed in a grid format on the homepage.
                </div>

                <!-- Ways to Travel Categories List -->
                <div id="waysToTravelList" class="row">
                    <!-- Categories will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Ways to Travel Configuration -->
<div class="modal fade" id="waysToTravelModal" tabindex="-1" aria-labelledby="waysToTravelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="waysToTravelModalLabel">Configure Ways to Travel Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="waysToTravelForm">
                    <input type="hidden" id="wtCategoryId">
                    <input type="hidden" id="wtEditId">
                    
                                         <div class="row">
                         <div class="col-md-6 mb-3">
                             <label class="form-label">Select Category <span class="text-danger">*</span></label>
                             <input type="hidden" id="wtCategorySelect" required>
                             <div id="wtCategoryTree" class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto; overflow-x: hidden;">
                                 <div class="text-center text-muted">Loading categories...</div>
                             </div>
                             <small class="text-muted">Select a category to display in Ways to Travel section (Only TOURS type)</small>
                         </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Display Order</label>
                            <input type="number" class="form-control" id="wtDisplayOrder" value="0" min="0">
                            <small class="text-muted">Order on homepage (0 = first)</small>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="wtIsActive">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">Images <span class="text-danger">*</span></label>
                            <small class="text-muted d-block mb-2">Select up to 2 images for this category. First image is required.</small>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small">Image 1 (Required)</label>
                                    <div class="border rounded p-2">
                                        <div id="wtImage1Preview" class="mb-2" style="display:none;">
                                            <img id="wtImage1PreviewImg" src="" alt="Preview" class="img-thumbnail" style="max-height: 200px;">
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="openImageGallery('wtImage1Url', 'wtImage1Preview', 'wtImage1PreviewImg')">
                                            <i class="ti ti-photo me-1"></i>Select Image 1
                                        </button>
                                        <input type="hidden" id="wtImage1Url" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Image 2 (Optional)</label>
                                    <div class="border rounded p-2">
                                        <div id="wtImage2Preview" class="mb-2" style="display:none;">
                                            <img id="wtImage2PreviewImg" src="" alt="Preview" class="img-thumbnail" style="max-height: 200px;">
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="openImageGallery('wtImage2Url', 'wtImage2Preview', 'wtImage2PreviewImg')">
                                            <i class="ti ti-photo me-1"></i>Select Image 2
                                        </button>
                                        <input type="hidden" id="wtImage2Url">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveWaysToTravelBtn">Save Configuration</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Image Gallery -->
<div class="modal fade" id="imageGalleryModal" tabindex="-1" aria-labelledby="imageGalleryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageGalleryModalLabel">Select Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs for Uploaded and New Upload -->
                <ul class="nav nav-tabs mb-3" id="imageTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="uploaded-tab" data-bs-toggle="tab" data-bs-target="#uploaded" type="button" role="tab">Uploaded Images</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">Upload New</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="imageTabContent">
                    <!-- Uploaded Images -->
                    <div class="tab-pane fade show active" id="uploaded" role="tabpanel">
                        <div class="row g-2" id="uploadedImagesGrid">
                            <!-- Images will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Upload New -->
                    <div class="tab-pane fade" id="upload" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label">Upload New Image</label>
                            <input type="file" class="form-control" id="newImageUpload" accept="image/*">
                            <small class="text-muted">Allowed: JPG, PNG, GIF, WebP (Max: 10MB)</small>
                        </div>
                        <div id="newImagePreview" style="display:none;">
                            <img id="newImagePreviewImg" src="" alt="Preview" class="img-thumbnail" style="max-height: 300px;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="selectImageBtn" disabled>Select This Image</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        .image-select-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .image-select-card:hover {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
            transform: translateY(-2px);
        }
        
        /* Category Tree Styles */
        #categoryTree {
            background-color: #f8f9fa;
        }
        .category-tree-item {
            margin: 2px 0;
        }
        .category-item-row {
            transition: background-color 0.2s ease;
        }
        .category-item-row:hover {
            background-color: #e9ecef !important;
        }
        .category-item-row.bg-primary {
            background-color: #0d6efd !important;
        }
        .expand-icon {
            transition: transform 0.2s ease;
        }
        .expand-icon:hover {
            transform: scale(1.2);
        }
    </style>
    <script>
        let allSections = []; // Store all sections globally
        // Ways to Travel Variables
        let allWaysToTravelCategories = [];
        let currentImageGalleryTarget = null;
        let currentImagePreviewDiv = null;
        let currentImagePreviewImg = null;

        $(document).ready(function() {
            loadCategories();
            loadHomepageSections();
            loadWaysToTravelCategories();
            loadCategoriesForWaysToTravel();
            
            // Layout Style Hover Demo
            initLayoutDemo();
            
            // Toggle spotlight image field based on layout style
            $('#layoutStyle').on('change', function() {
                const layoutStyle = $(this).val();
                if (layoutStyle === 'spotlight') {
                    $('#spotlightImageContainer').slideDown(300);
                } else {
                    $('#spotlightImageContainer').slideUp(300);
                }
            });
            
            // Initial check on page load
            if ($('#layoutStyle').val() === 'spotlight') {
                $('#spotlightImageContainer').show();
            }
        });
        
        // Initialize Layout Demo
        function initLayoutDemo() {
            const $layoutStyle = $('#layoutStyle');
            const $demo = $('#layoutDemo');
            let hoverTimeout;
            
            // Show demo on hover
            $layoutStyle.on('mouseenter', function() {
                clearTimeout(hoverTimeout);
                const selectedValue = $(this).val();
                showLayoutDemo(selectedValue);
            });
            
            // Hide demo on mouse leave
            $layoutStyle.on('mouseleave', function() {
                hoverTimeout = setTimeout(function() {
                    $demo.fadeOut(200);
                }, 300);
            });
            
            // Keep demo visible when hovering over it
            $demo.on('mouseenter', function() {
                clearTimeout(hoverTimeout);
                $(this).show();
            });
            
            $demo.on('mouseleave', function() {
                $(this).fadeOut(200);
            });
        }
        
        // Show layout demo
        function showLayoutDemo(layoutType) {
            const $demo = $('#layoutDemo');
            const $title = $('#demoTitle');
            const $content = $('#demoContent');
            
            let title = '';
            let description = '';
            let demoHtml = '';
            
            switch(layoutType) {
                case 'grid':
                    title = 'Grid (4 columns)';
                    description = 'Displays tours in a responsive 4-column grid layout with horizontal scrolling.';
                    demoHtml = `
                        <div class="border rounded p-2" style="background: #f8f9fa;">
                            <div class="d-flex gap-2 mb-2">
                                <div class="border rounded p-1 bg-white text-center" style="flex: 1; min-height: 40px;">Card 1</div>
                                <div class="border rounded p-1 bg-white text-center" style="flex: 1; min-height: 40px;">Card 2</div>
                                <div class="border rounded p-1 bg-white text-center" style="flex: 1; min-height: 40px;">Card 3</div>
                                <div class="border rounded p-1 bg-white text-center" style="flex: 1; min-height: 40px;">Card 4</div>
                            </div>
                            <div class="text-center text-muted small">← Swipe to see more →</div>
                        </div>
                    `;
                    break;
                case 'grid-3':
                    title = 'Grid (3 columns)';
                    description = 'Displays tours in a 3-column grid with a featured content panel on the right.';
                    demoHtml = `
                        <div class="border rounded p-2" style="background: #f8f9fa;">
                            <div class="d-flex gap-2">
                                <div style="flex: 2;">
                                    <div class="d-flex gap-2 mb-2">
                                        <div class="border rounded p-1 bg-white text-center" style="flex: 1; min-height: 50px;">1</div>
                                        <div class="border rounded p-1 bg-white text-center" style="flex: 1; min-height: 50px;">2</div>
                                        <div class="border rounded p-1 bg-white text-center" style="flex: 1; min-height: 50px;">3</div>
                                    </div>
                                </div>
                                <div style="flex: 1; background: #0d6efd; border-radius: 4px; color: white; padding: 8px; font-size: 10px;">
                                    <strong>Featured</strong><br>
                                    Content Panel
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'grid-2':
                    title = 'Grid (2 columns)';
                    description = 'Displays tours in a simple 2-column grid layout.';
                    demoHtml = `
                        <div class="border rounded p-2" style="background: #f8f9fa;">
                            <div class="d-flex gap-2 mb-2">
                                <div class="border rounded p-1 bg-white text-center" style="flex: 1; min-height: 60px;">Card 1</div>
                                <div class="border rounded p-1 bg-white text-center" style="flex: 1; min-height: 60px;">Card 2</div>
                            </div>
                            <div class="d-flex gap-2">
                                <div class="border rounded p-1 bg-white text-center" style="flex: 1; min-height: 60px;">Card 3</div>
                                <div class="border rounded p-1 bg-white text-center" style="flex: 1; min-height: 60px;">Card 4</div>
                            </div>
                        </div>
                    `;
                    break;
                case 'spotlight':
                    title = 'Spotlight (Large cards)';
                    description = 'Displays large promotional cards with content panel on left/right, alternating layout.';
                    demoHtml = `
                        <div class="border rounded p-2" style="background: #f8f9fa;">
                            <div class="d-flex gap-2 mb-2">
                                <div style="flex: 1; background: #0d6efd; border-radius: 4px; color: white; padding: 8px; font-size: 10px;">
                                    <strong>FEATURED</strong><br>
                                    <small>Promo Content Panel</small>
                                </div>
                                <div style="flex: 2;">
                                    <div class="border rounded p-1 bg-white" style="min-height: 50px;">Large Tour Card</div>
                                </div>
                            </div>
                            <div class="text-center text-muted small">Next section: Content on right</div>
                        </div>
                    `;
                    break;
                case 'carousel':
                    title = 'Carousel';
                    description = 'Displays tours in a carousel/slider with navigation arrows.';
                    demoHtml = `
                        <div class="border rounded p-2" style="background: #f8f9fa;">
                            <div class="position-relative">
                                <div class="d-flex gap-2 overflow-hidden" style="max-width: 100%;">
                                    <div class="border rounded p-1 bg-white text-center" style="flex: 0 0 100%; min-height: 50px;">Slide 1</div>
                                </div>
                                <button class="btn btn-sm btn-primary position-absolute" style="left: -10px; top: 50%; transform: translateY(-50%); border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 10px;">‹</button>
                                <button class="btn btn-sm btn-primary position-absolute" style="right: -10px; top: 50%; transform: translateY(-50%); border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 10px;">›</button>
                            </div>
                            <div class="text-center text-muted small mt-2">← Click arrows to navigate →</div>
                        </div>
                    `;
                    break;
            }
            
            $title.text(title);
            $content.html(`<p class="small text-muted mb-2">${description}</p>${demoHtml}`);
            $demo.fadeIn(200);
        }

        // Load all categories for selection (with tree structure)
        function loadCategories() {
            $.ajax({
                url: '/api/Category/tree',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        const container = $('#categoryTree');
                        container.empty();
                        
                        if (response.data.length === 0) {
                            container.append('<div class="text-muted text-center">No categories available</div>');
                            return;
                        }
                        
                        // Recursively build category tree
                        function buildCategoryTree(categories, container, level = 0) {
                            categories.forEach(function(category) {
                                // Only show categories with type='TOURS' and totalTours > 0
                                if (category.type === 'TOURS' && category.totalTours > 0) {
                                    // Check if children has any valid categories
                                    const validChildren = category.children ? category.children.filter(child => child.type === 'TOURS' && child.totalTours > 0) : [];
                                    const hasChildren = validChildren.length > 0;
                                    
                                    const item = $(`
                                        <div class="category-tree-item" data-category-id="${category.id}" style="padding-left: ${level * 20}px;">
                                            <div class="d-flex align-items-center mb-1 category-item-row" style="cursor: pointer; padding: 5px; border-radius: 4px;" 
                                                 ${hasChildren ? '' : 'onclick="selectCategory(' + category.id + ', \'' + category.categoryName.replace(/'/g, "\\'") + '\')"'}
                                                 onmouseover="this.style.backgroundColor='#f0f0f0'" 
                                                 onmouseout="this.style.backgroundColor='transparent'">
                                                ${hasChildren ? '<i class="ti ti-plus me-2 expand-icon" style="width: 16px; text-align: center; cursor: pointer;" onclick="toggleCategory(this, event)"></i>' : '<span class="me-2" style="width: 16px;"></span>'}
                                                <span class="category-name flex-grow-1">${category.categoryName}</span>
                                                <span class="badge bg-info ms-1">${category.totalTours} tours</span>
                                            </div>
                                            <div class="category-children" style="display: none;"></div>
                                        </div>
                                    `);
                                    
                                    container.append(item);
                                    
                                    // If has children, populate them
                                    if (hasChildren) {
                                        buildCategoryTree(validChildren, item.find('.category-children'), level + 1);
                                    }
                                }
                            });
                        }
                        
                        buildCategoryTree(response.data, container);
                    }
                },
                error: function() {
                    $('#categoryTree').html('<div class="text-danger text-center">Error loading categories</div>');
                }
            });
        }

        // Toggle category expansion
        window.toggleCategory = function(iconElement, event) {
            event.stopPropagation();
            const $icon = $(iconElement);
            const $children = $icon.closest('.category-tree-item').find('.category-children');
            
            if ($children.is(':visible')) {
                $children.slideUp(200);
                $icon.removeClass('ti-minus').addClass('ti-plus');
            } else {
                $children.slideDown(200);
                $icon.removeClass('ti-plus').addClass('ti-minus');
            }
        };

        // Select category
        window.selectCategory = function(categoryId, categoryName) {
            $('#categorySelect').val(categoryId);
            
            // Visual feedback - highlight selected
            $('.category-item-row').removeClass('bg-primary text-white');
            $(`.category-tree-item[data-category-id="${categoryId}"] .category-item-row`).addClass('bg-primary text-white');
            
            showToast(`Selected category: ${categoryName}`, 'success');
        };

                 // Load categories for Ways to Travel (with tree structure)
         function loadCategoriesForWaysToTravel() {
             $.ajax({
                 url: '/api/Category/tree',
                 type: 'GET',
                 success: function(response) {
                     if (response.success && response.data) {
                         const container = $('#wtCategoryTree');
                         container.empty();
                         
                         if (response.data.length === 0) {
                             container.append('<div class="text-muted text-center">No categories available</div>');
                             return;
                         }
                         
                         // Recursively build category tree
                         function buildWTCategoryTree(categories, container, level = 0) {
                             categories.forEach(function(category) {
                                 // Only show categories with type='TOURS' and totalTours > 0
                                 if (category.type === 'TOURS' && category.totalTours > 0) {
                                     // Check if children has any valid categories
                                     const validChildren = category.children ? category.children.filter(child => child.type === 'TOURS' && child.totalTours > 0) : [];
                                     const hasChildren = validChildren.length > 0;
                                     
                                     const item = $(`
                                         <div class="category-tree-item" data-category-id="${category.id}" style="padding-left: ${level * 20}px;">
                                             <div class="d-flex align-items-center mb-1 category-item-row" style="cursor: pointer; padding: 5px; border-radius: 4px;" 
                                                  ${hasChildren ? '' : 'onclick="selectWTCategory(' + category.id + ', \'' + category.categoryName.replace(/'/g, "\\'") + '\')"'}
                                                  onmouseover="this.style.backgroundColor='#f0f0f0'" 
                                                  onmouseout="this.style.backgroundColor='transparent'">
                                                 ${hasChildren ? '<i class="ti ti-plus me-2 expand-icon" style="width: 16px; text-align: center; cursor: pointer;" onclick="toggleCategory(this, event)"></i>' : '<span class="me-2" style="width: 16px;"></span>'}
                                                 <span class="category-name flex-grow-1">${category.categoryName}</span>
                                                 <span class="badge bg-info ms-1">${category.totalTours} tours</span>
                                             </div>
                                             <div class="category-children" style="display: none;"></div>
                                         </div>
                                     `);
                                     
                                     container.append(item);
                                     
                                     // If has children, populate them
                                     if (hasChildren) {
                                         buildWTCategoryTree(validChildren, item.find('.category-children'), level + 1);
                                     }
                                 }
                             });
                         }
                         
                         buildWTCategoryTree(response.data, container);
                     }
                 },
                 error: function() {
                     $('#wtCategoryTree').html('<div class="text-danger text-center">Error loading categories</div>');
                 }
             });
         }

         // Select category for Ways to Travel
         window.selectWTCategory = function(categoryId, categoryName) {
             $('#wtCategorySelect').val(categoryId);
             
             // Visual feedback - highlight selected
             $('#wtCategoryTree .category-item-row').removeClass('bg-primary text-white');
             $('#wtCategoryTree').find(`[data-category-id="${categoryId}"] .category-item-row`).addClass('bg-primary text-white');
             
             showToast(`Selected category: ${categoryName}`, 'success');
         };

        // Load Ways to Travel categories
        function loadWaysToTravelCategories() {
            $.ajax({
                url: '/api/HomePage/ways-to-travel',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        allWaysToTravelCategories = response.data.categories;
                        displayWaysToTravelCategories(allWaysToTravelCategories);
                    }
                },
                error: function() {
                    showToast('Error loading Ways to Travel categories', 'danger');
                }
            });
        }

        // Display Ways to Travel categories
        function displayWaysToTravelCategories(categories) {
            const container = $('#waysToTravelList');
            container.empty();

            if (!categories || categories.length === 0) {
                container.append(`
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="ti ti-info-circle me-2"></i>
                            No categories configured yet. Click "Add Category to Ways to Travel" to get started.
                        </div>
                    </div>
                `);
                return;
            }

            // Sort by display order
            categories.sort((a, b) => a.displayOrder - b.displayOrder);

            categories.forEach(function(category) {
                const imagesHtml = category.imageUrl2 
                    ? `<div class="d-flex gap-2">
                          <img src="${category.imageUrl1}" alt="Image 1" class="img-thumbnail" style="max-width: 150px; max-height: 100px;">
                          <img src="${category.imageUrl2}" alt="Image 2" class="img-thumbnail" style="max-width: 150px; max-height: 100px;">
                        </div>`
                    : `<img src="${category.imageUrl1}" alt="Image 1" class="img-thumbnail" style="max-width: 150px; max-height: 100px;">`;

                container.append(`
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card border h-100">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">${category.categoryName}</h6>
                                    <span class="badge bg-success">Active</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted">Tours:</small>
                                    <div class="fw-bold">${category.totalTours} tours available</div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Images:</small>
                                    ${imagesHtml}
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Display Order:</small>
                                    <div>${category.displayOrder}</div>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent border-0 pt-0">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editWaysToTravel(${category.categoryId})" title="Edit">
                                        <i class="ti ti-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="moveWaysToTravelUp(${category.categoryId})" title="Move Up">
                                        <i class="ti ti-arrow-up"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="moveWaysToTravelDown(${category.categoryId})" title="Move Down">
                                        <i class="ti ti-arrow-down"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteWaysToTravel(${category.categoryId})" title="Delete">
                                        <i class="ti ti-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            });
        }

        // Open image gallery modal
        window.openImageGallery = function(targetInputId, previewDivId, previewImgId) {
            currentImageGalleryTarget = targetInputId;
            currentImagePreviewDiv = previewDivId;
            currentImagePreviewImg = previewImgId;
            
            $('#imageGalleryModal').modal('show');
            loadUploadedImages();
        };
        
        // Open spotlight image gallery
        window.openSpotlightImageGallery = function() {
            currentImageGalleryTarget = 'spotlightImageUrl';
            currentImagePreviewDiv = 'spotlightImagePreview';
            currentImagePreviewImg = 'spotlightImagePreviewImg';
            
            $('#imageGalleryModal').modal('show');
            loadUploadedImages();
        };

        // Load uploaded images
        function loadUploadedImages() {
            const grid = $('#uploadedImagesGrid');
            grid.empty();
            grid.append('<div class="col-12 text-center"><p>Loading images...</p></div>');

            $.ajax({
                url: '/api/FileUpload/images',
                type: 'GET',
                success: function(response) {
                    grid.empty();
                    
                    if (response.success && response.data && response.data.length > 0) {
                        response.data.forEach(function(image) {
                            grid.append(`
                                <div class="col-md-3 col-sm-4 col-6">
                                    <div class="card image-select-card" onclick="selectUploadedImage('${image.fileUrl}')">
                                        <img src="${image.fileUrl}" class="card-img-top" alt="Image" style="height: 150px; object-fit: cover;">
                                        <div class="card-body p-2 text-center">
                                            <small class="text-muted">${image.fileName}</small>
                                        </div>
                                    </div>
                                </div>
                            `);
                        });
                    } else {
                        grid.append('<div class="col-12 text-center"><p class="text-muted">No uploaded images found. Upload a new image using the "Upload New" tab.</p></div>');
                    }
                },
                error: function() {
                    grid.empty();
                    grid.append('<div class="col-12 text-center"><p class="text-danger">Error loading images</p></div>');
                }
            });
        }

        // Select uploaded image
        window.selectUploadedImage = function(imageUrl) {
            $('#' + currentImageGalleryTarget).val(imageUrl);
            $('#' + currentImagePreviewDiv).show();
            $('#' + currentImagePreviewImg).attr('src', imageUrl);
            $('#selectImageBtn').prop('disabled', false);
            $('#selectedImageUrl').val(imageUrl);
        };

        // Handle new image upload
        $('#newImageUpload').on('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validate file type
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    showToast('Invalid file type. Please select an image file.', 'danger');
                    return;
                }

                // Validate file size (10MB max)
                if (file.size > 10 * 1024 * 1024) {
                    showToast('File size too large. Maximum 10MB allowed.', 'danger');
                    return;
                }

                // Upload file immediately
                const formData = new FormData();
                formData.append('file', file);

                // Show loading
                $('#selectImageBtn').prop('disabled', true).text('Uploading...');

                $.ajax({
                    url: '/api/FileUpload/image',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success && response.data) {
                            const imageUrl = response.data.fileUrl;
                            
                            // Store the uploaded image URL
                            $('#selectedImageUrl').val(imageUrl);
                            
                            // Preview image
                            $('#newImagePreview').show();
                            $('#newImagePreviewImg').attr('src', imageUrl);
                            $('#selectImageBtn').prop('disabled', false).text('Select This Image');
                            
                            showToast('Image uploaded successfully!', 'success');
                        } else {
                            showToast(response.message || 'Failed to upload image', 'danger');
                            $('#selectImageBtn').prop('disabled', true).text('Select This Image');
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.message || 'Failed to upload image';
                        showToast(errorMsg, 'danger');
                        $('#selectImageBtn').prop('disabled', true).text('Select This Image');
                    }
                });
            }
        });

        // Apply selected image
        $('#selectImageBtn').on('click', function() {
            const imageUrl = $('#selectedImageUrl').val() || $('#newImagePreviewImg').attr('src');
            if (imageUrl) {
                $('#' + currentImageGalleryTarget).val(imageUrl);
                $('#' + currentImagePreviewDiv).show();
                $('#' + currentImagePreviewImg).attr('src', imageUrl);
                $('#imageGalleryModal').modal('hide');
                
                // Reset
                $('#newImageUpload').val('');
                $('#newImagePreview').hide();
                $('#selectImageBtn').prop('disabled', true);
                $('#selectedImageUrl').val('');
            }
        });

        // Save Ways to Travel category
        $('#saveWaysToTravelBtn').on('click', function() {
            const form = $('#waysToTravelForm')[0];
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const categoryId = $('#wtCategorySelect').val();
            const imageUrl1 = $('#wtImage1Url').val();

            if (!imageUrl1) {
                showToast('Please select at least Image 1', 'danger');
                return;
            }

            const waysToTravelData = {
                imageUrl1: imageUrl1,
                imageUrl2: $('#wtImage2Url').val() || null,
                displayOrder: parseInt($('#wtDisplayOrder').val()),
                showInWaysToTravel: $('#wtIsActive').val() === 'true'
            };

            $.ajax({
                url: `/api/HomePage/category/${categoryId}/ways-to-travel`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(waysToTravelData),
                success: function(response) {
                    if (response.success) {
                        showToast('Ways to Travel category configured successfully!', 'success');
                        $('#waysToTravelModal').modal('hide');
                        loadWaysToTravelCategories();
                    } else {
                        showToast(response.message || 'Failed to save configuration', 'danger');
                    }
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.message || 'Failed to save configuration';
                    showToast(errorMsg, 'danger');
                }
            });
        });

        // Edit Ways to Travel category
        window.editWaysToTravel = function(categoryId) {
            const category = allWaysToTravelCategories.find(c => c.categoryId === categoryId);
            if (!category) {
                showToast('Category not found', 'danger');
                return;
            }

            $('#wtCategoryId').val(category.categoryId);
            $('#wtCategorySelect').val(category.categoryId);
            $('#wtImage1Url').val(category.imageUrl1);
            $('#wtImage2Url').val(category.imageUrl2 || '');
            $('#wtDisplayOrder').val(category.displayOrder);
            $('#wtIsActive').val('true');

            // Show image previews
            if (category.imageUrl1) {
                $('#wtImage1Preview').show();
                $('#wtImage1PreviewImg').attr('src', category.imageUrl1);
            }
            if (category.imageUrl2) {
                $('#wtImage2Preview').show();
                $('#wtImage2PreviewImg').attr('src', category.imageUrl2);
            }

            // Highlight selected category in tree
            $('#wtCategoryTree .category-item-row').removeClass('bg-primary text-white');
            setTimeout(() => {
                $('#wtCategoryTree').find(`[data-category-id="${category.categoryId}"] .category-item-row`).addClass('bg-primary text-white');
            }, 100);

            $('#waysToTravelModal').modal('show');
        };

        // Delete Ways to Travel category
        window.deleteWaysToTravel = function(categoryId) {
            if (!confirm('Are you sure you want to remove this category from Ways to Travel?')) {
                return;
            }

            $.ajax({
                url: `/api/HomePage/category/${categoryId}/ways-to-travel`,
                type: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        showToast('Category removed from Ways to Travel', 'success');
                        loadWaysToTravelCategories();
                    } else {
                        showToast(response.message || 'Failed to remove category', 'danger');
                    }
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.message || 'Failed to remove category';
                    showToast(errorMsg, 'danger');
                }
            });
        };

        // Move Ways to Travel category up
        window.moveWaysToTravelUp = function(categoryId) {
            const currentCategory = allWaysToTravelCategories.find(c => c.categoryId === categoryId);
            if (!currentCategory) {
                showToast('Category not found', 'danger');
                return;
            }

            const currentOrder = currentCategory.displayOrder;
            const prevCategory = allWaysToTravelCategories.find(c => c.displayOrder === currentOrder - 1);

            if (!prevCategory) {
                showToast('Cannot move up further', 'warning');
                return;
            }

            // Swap orders - send both in one request
            const reorderData = [
                { categoryId: categoryId, displayOrder: currentOrder - 1 },
                { categoryId: prevCategory.categoryId, displayOrder: currentOrder }
            ];
            
            reorderWaysToTravelCategories(reorderData);
        };

        // Move Ways to Travel category down
        window.moveWaysToTravelDown = function(categoryId) {
            const currentCategory = allWaysToTravelCategories.find(c => c.categoryId === categoryId);
            if (!currentCategory) {
                showToast('Category not found', 'danger');
                return;
            }

            const currentOrder = currentCategory.displayOrder;
            const nextCategory = allWaysToTravelCategories.find(c => c.displayOrder === currentOrder + 1);

            if (!nextCategory) {
                showToast('Cannot move down further', 'warning');
                return;
            }

            // Swap orders - send both in one request
            const reorderData = [
                { categoryId: categoryId, displayOrder: currentOrder + 1 },
                { categoryId: nextCategory.categoryId, displayOrder: currentOrder }
            ];
            
            reorderWaysToTravelCategories(reorderData);
        };

        // Helper function to reorder multiple categories
        function reorderWaysToTravelCategories(reorderData) {
            $.ajax({
                url: `/api/HomePage/ways-to-travel/reorder`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(reorderData),
                success: function(response) {
                    if (response.success) {
                        showToast('Categories reordered successfully', 'success');
                        loadWaysToTravelCategories();
                    } else {
                        showToast(response.message || 'Failed to reorder', 'danger');
                    }
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.message || 'Failed to reorder categories';
                    showToast(errorMsg, 'danger');
                }
            });
        }

        // Reset modal on close
        $('#waysToTravelModal').on('hidden.bs.modal', function () {
            $('#waysToTravelForm')[0].reset();
            $('#wtCategorySelect').val('');
            $('#wtImage1Preview').hide();
            $('#wtImage2Preview').hide();
            $('#waysToTravelModalLabel').text('Add Category to Ways to Travel');
            // Clear category selection highlight
            $('#wtCategoryTree .category-item-row').removeClass('bg-primary text-white');
        });

        // Add hidden input for selected image URL
        if ($('#selectedImageUrl').length === 0) {
            $('body').append('<input type="hidden" id="selectedImageUrl">');
        }

        // Load configured homepage sections
        function loadHomepageSections() {
            $.ajax({
                url: '/api/HomePage/sections',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        // Convert API response to local format
                        allSections = response.data.sections.map(function(section, index) {
                            return {
                                id: index + 1, // Use index as ID
                                categoryId: section.categoryId,
                                categoryName: section.categoryName,
                                sectionTitle: section.homepageTitle,
                                layoutStyle: section.config.layoutStyle,
                                maxItems: section.config.maxItems,
                                displayOrder: section.config.displayOrder,
                                isActive: section.config.isActive,
                                badgeText: section.config.badgeText || '',
                                customClass: section.config.customClass || '',
                                spotlightImageUrl: section.config.spotlightImageUrl || '',
                                tourCount: section.tourCount
                            };
                        });

                        displayHomepageSections(allSections);
                    }
                },
                error: function() {
                    showToast('Error loading homepage sections', 'danger');
                }
            });
        }

        // Display homepage sections
        function displayHomepageSections(sections) {
            const container = $('#homepageSectionsList');
            container.empty();

            if (!sections || sections.length === 0) {
                container.append(`
                    <div class="col-12">
                        <div class="alert alert-warning text-center">
                            <i class="ti ti-info-circle me-2"></i>
                            No sections configured yet. Click "Configure New Section" to get started.
                        </div>
                    </div>
                `);
                return;
            }

            // Sort by display order
            sections.sort((a, b) => a.displayOrder - b.displayOrder);

            sections.forEach(function(section) {
                const activeBadge = section.isActive ? 
                    '<span class="badge bg-success">Active</span>' : 
                    '<span class="badge bg-secondary">Inactive</span>';

                const layoutBadge = getLayoutBadge(section.layoutStyle);

                container.append(`
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card border h-100">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">${section.sectionTitle}</h6>
                                    ${activeBadge}
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted">Category:</small>
                                    <div class="fw-bold">${section.categoryName}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6">
                                        <small class="text-muted">Tours:</small>
                                        <div>${section.tourCount} available</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Display:</small>
                                        <div>${section.maxItems} items</div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Layout:</small>
                                    <div>${layoutBadge}</div>
                                </div>
                                ${section.badgeText ? `
                                    <div class="mb-2">
                                        <small class="text-muted">Badge:</small>
                                        <div><span class="badge bg-primary">${section.badgeText}</span></div>
                                    </div>
                                ` : ''}
                                <div class="mb-2">
                                    <small class="text-muted">Order:</small>
                                    <div>${section.displayOrder}</div>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent border-0 pt-0">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editSection(${section.id})" title="Edit">
                                        <i class="ti ti-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="previewSection(${section.id})" title="Preview">
                                        <i class="ti ti-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="moveSectionUp(${section.id})" title="Move Up">
                                        <i class="ti ti-arrow-up"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="moveSectionDown(${section.id})" title="Move Down">
                                        <i class="ti ti-arrow-down"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSection(${section.id})" title="Delete">
                                        <i class="ti ti-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            });
        }

        // Get layout badge styling
        function getLayoutBadge(layoutStyle) {
            const badges = {
                'grid': '<span class="badge bg-primary">Grid (4 cols)</span>',
                'grid-3': '<span class="badge bg-primary">Grid (3 cols)</span>',
                'grid-2': '<span class="badge bg-primary">Grid (2 cols)</span>',
                'spotlight': '<span class="badge bg-warning">Spotlight</span>',
                'carousel': '<span class="badge bg-info">Carousel</span>'
            };
            return badges[layoutStyle] || '<span class="badge bg-secondary">Custom</span>';
        }

        // Handle modal reset
        $('#addSectionModal').on('hidden.bs.modal', function () {
            $('#sectionForm')[0].reset();
            $('#sectionId').val('');
            $('#categoryId').val('');
            $('#categorySelect').val('');
            $('#addSectionModalLabel').text('Configure Homepage Section');
            // Clear category selection highlight
            $('.category-item-row').removeClass('bg-primary text-white');
            // Re-enable category tree
            $('#categoryTree').css('opacity', '1');
            $('#categoryTree').css('pointer-events', 'auto');
            // Restore original helper text
            $('#categoryTree').next('small').text('Tours from this category will be displayed (Only TOURS type)');
            // Reset spotlight image
            $('#spotlightImageUrl').val('');
            $('#spotlightImagePreview').hide();
            $('#spotlightImageContainer').hide();
        });

        // Save section
        $('#saveSectionBtn').on('click', function() {
            const form = $('#sectionForm')[0];
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Use categoryId from hidden input if editing, otherwise use categorySelect
            const editCategoryId = $('#categoryId').val();
            const categoryId = editCategoryId || $('#categorySelect').val();
            
            if (!categoryId) {
                showToast('Please select a category', 'danger');
                return;
            }
            
            // Validate spotlight image if spotlight layout
            const layoutStyle = $('#layoutStyle').val();
            const spotlightImageUrl = $('#spotlightImageUrl').val();
            
            if (layoutStyle === 'spotlight' && !spotlightImageUrl) {
                showToast('Please select a spotlight background image', 'danger');
                return;
            }
            
            const sectionData = {
                homepageTitle: $('#sectionTitle').val(),
                layoutStyle: layoutStyle,
                maxItems: parseInt($('#maxItems').val()),
                displayOrder: parseInt($('#displayOrder').val()),
                isActive: $('#isActive').val() === 'true',
                badgeText: $('#badgeText').val() || null,
                customClass: $('#customClass').val() || null,
                spotlightImageUrl: spotlightImageUrl || null
            };

            // Call API
            $.ajax({
                url: `/api/HomePage/category/${categoryId}/homepage`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(sectionData),
                success: function(response) {
                    if (response.success) {
                        showToast(response.message || 'Section saved successfully!', 'success');
                        $('#addSectionModal').modal('hide');
                        loadHomepageSections();
                    } else {
                        showToast(response.message || 'Failed to save section', 'danger');
                    }
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.message || 'Failed to save section';
                    showToast(errorMsg, 'danger');
                }
            });
        });

        // Action functions
        window.editSection = function(id) {
            const section = allSections.find(s => s.id === id);
            if (!section) {
                showToast('Section not found', 'danger');
                return;
            }

            // Populate modal with section data
            $('#addSectionModalLabel').text('Edit Homepage Section');
            $('#sectionId').val(section.id);
            $('#categoryId').val(section.categoryId);
            $('#categorySelect').val(section.categoryId);
            $('#sectionTitle').val(section.sectionTitle);
            $('#layoutStyle').val(section.layoutStyle);
            $('#maxItems').val(section.maxItems);
            $('#displayOrder').val(section.displayOrder);
            $('#isActive').val(section.isActive.toString());
            $('#badgeText').val(section.badgeText);
            $('#customClass').val(section.customClass);
            
            // Handle spotlight image
            if (section.spotlightImageUrl) {
                $('#spotlightImageUrl').val(section.spotlightImageUrl);
                $('#spotlightImagePreview').show();
                $('#spotlightImagePreviewImg').attr('src', section.spotlightImageUrl);
            }
            
            // Show spotlight image container if spotlight layout
            if (section.layoutStyle === 'spotlight') {
                $('#spotlightImageContainer').show();
            } else {
                $('#spotlightImageContainer').hide();
            }

            // Disable category tree when editing (can't change category)
            $('#categoryTree').css('opacity', '0.5');
            $('#categoryTree').css('pointer-events', 'none');
            
            // Update helper text to show category cannot be changed
            $('#categoryTree').next('small').text('Category cannot be changed when editing');

            // Highlight selected category in tree
            $('.category-item-row').removeClass('bg-primary text-white');
            setTimeout(() => {
                $(`.category-tree-item[data-category-id="${section.categoryId}"] .category-item-row`).addClass('bg-primary text-white');
            }, 100);

            $('#addSectionModal').modal('show');
        };

        window.previewSection = function(id) {
            const section = allSections.find(s => s.id === id);
            if (!section) {
                showToast('Section not found', 'danger');
                return;
            }

            // Show loading
            $('#sectionPreview').html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');
            $('#previewSectionModal').modal('show');

            // Load real tours from API
            $.ajax({
                url: `/api/Tour/by-category/${section.categoryId}`,
                type: 'GET',
                data: { maxItems: section.maxItems },
                success: function(response) {
                    if (response.success && response.data) {
                        const previewHtml = generatePreviewHtml(section, response.data);
                        $('#sectionPreview').html(previewHtml);
                    } else {
                        $('#sectionPreview').html('<div class="alert alert-warning">No tours found for this category.</div>');
                    }
                },
                error: function() {
                    $('#sectionPreview').html('<div class="alert alert-danger">Error loading tours. Please try again.</div>');
                }
            });
        };

        window.moveSectionUp = function(id) {
            const section = allSections.find(s => s.id === id);
            if (!section || section.displayOrder <= 1) {
                showToast('Cannot move up further', 'warning');
                return;
            }

            const prevSection = allSections.find(s => s.displayOrder === section.displayOrder - 1);
            if (prevSection) {
                // Swap display orders
                const tempOrder = section.displayOrder;
                section.displayOrder = prevSection.displayOrder;
                prevSection.displayOrder = tempOrder;
                
                // Call API to persist changes
                const reorderData = [
                    { categoryId: section.categoryId, displayOrder: section.displayOrder },
                    { categoryId: prevSection.categoryId, displayOrder: prevSection.displayOrder }
                ];
                
                $.ajax({
                    url: '/api/HomePage/sections/reorder',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(reorderData),
                    success: function(response) {
                        if (response.success) {
                            showToast('Section moved up successfully', 'success');
                            loadHomepageSections();
                        } else {
                            showToast(response.message || 'Failed to move section', 'danger');
                            loadHomepageSections(); // Reload to restore original order
                        }
                    },
                    error: function(xhr) {
                        showToast(xhr.responseJSON?.message || 'Failed to move section', 'danger');
                        loadHomepageSections(); // Reload to restore original order
                    }
                });
            }
        };

        window.moveSectionDown = function(id) {
            const section = allSections.find(s => s.id === id);
            const maxOrder = Math.max(...allSections.map(s => s.displayOrder));
            
            if (!section || section.displayOrder >= maxOrder) {
                showToast('Cannot move down further', 'warning');
                return;
            }

            const nextSection = allSections.find(s => s.displayOrder === section.displayOrder + 1);
            if (nextSection) {
                // Swap display orders
                const tempOrder = section.displayOrder;
                section.displayOrder = nextSection.displayOrder;
                nextSection.displayOrder = tempOrder;
                
                // Call API to persist changes
                const reorderData = [
                    { categoryId: section.categoryId, displayOrder: section.displayOrder },
                    { categoryId: nextSection.categoryId, displayOrder: nextSection.displayOrder }
                ];
                
                $.ajax({
                    url: '/api/HomePage/sections/reorder',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(reorderData),
                    success: function(response) {
                        if (response.success) {
                            showToast('Section moved down successfully', 'success');
                            loadHomepageSections();
                        } else {
                            showToast(response.message || 'Failed to move section', 'danger');
                            loadHomepageSections(); // Reload to restore original order
                        }
                    },
                    error: function(xhr) {
                        showToast(xhr.responseJSON?.message || 'Failed to move section', 'danger');
                        loadHomepageSections(); // Reload to restore original order
                    }
                });
            }
        };

        window.deleteSection = function(id) {
            const section = allSections.find(s => s.id === id);
            if (!section) {
                showToast('Section not found', 'danger');
                return;
            }

            $('#deleteSectionInfo').html(
                `<strong>Section:</strong> "${section.sectionTitle}"<br>` +
                `<strong>Category:</strong> ${section.categoryName}<br>` +
                `<strong>Order:</strong> ${section.displayOrder}`
            );

            $('#confirmDeleteBtn').off('click').on('click', function() {
                // Call API to delete
                $.ajax({
                    url: `/api/HomePage/category/${section.categoryId}/homepage`,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            showToast('Section removed from homepage', 'success');
                            $('#deleteSectionModal').modal('hide');
                            loadHomepageSections();
                        } else {
                            showToast(response.message || 'Failed to remove section', 'danger');
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.message || 'Failed to remove section';
                        showToast(errorMsg, 'danger');
                    }
                });
            });

            $('#deleteSectionModal').modal('show');
        };

        // Generate preview HTML
        function generatePreviewHtml(section, tours) {
            let html = `
                <div class="mb-3">
                    <h4>${section.sectionTitle}</h4>
                    ${section.badgeText ? `<span class="badge bg-primary mb-2">${section.badgeText}</span>` : ''}
                </div>
            `;

            if (tours.length === 0) {
                html += '<div class="alert alert-info">No tours available in this category.</div>';
                return html;
            }

            if (section.layoutStyle === 'spotlight') {
                html += '<div class="row g-3">';
                tours.forEach(tour => {
                    // Get image: use bannerImageUrl first, then first image from Images array
                    const imageUrl = tour.bannerImageUrl || (tour.images && tour.images.length > 0 ? tour.images[0] : null) || '/images/placeholder.jpg';
                    const price = tour.pricePerPerson || 0;
                    html += `
                        <div class="col-md-4">
                            <div class="card">
                                <img src="${imageUrl}" class="card-img-top" alt="${tour.title}" height="200" style="object-fit: cover;">
                                <div class="card-body">
                                    <h6 class="card-title">${tour.title}</h6>
                                    ${tour.duration ? `<p class="text-muted mb-2"><i class="ti ti-clock me-1"></i>${tour.duration}</p>` : ''}
                                    <p class="text-primary fw-bold mb-0">${price.toLocaleString()} VND</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else if (section.layoutStyle === 'grid-3') {
                html += '<div class="row g-3">';
                tours.forEach(tour => {
                    // Get image: use bannerImageUrl first, then first image from Images array
                    const imageUrl = tour.bannerImageUrl || (tour.images && tour.images.length > 0 ? tour.images[0] : null) || '/images/placeholder.jpg';
                    const price = tour.pricePerPerson || 0;
                    html += `
                        <div class="col-md-4">
                            <div class="card">
                                <img src="${imageUrl}" class="card-img-top" alt="${tour.title}" height="150" style="object-fit: cover;">
                                <div class="card-body">
                                    <h6 class="card-title">${tour.title}</h6>
                                    <p class="text-primary fw-bold mb-0">${price.toLocaleString()} VND</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<div class="row g-3">';
                tours.forEach(tour => {
                    // Get image: use bannerImageUrl first, then first image from Images array
                    const imageUrl = tour.bannerImageUrl || (tour.images && tour.images.length > 0 ? tour.images[0] : null) || '/images/placeholder.jpg';
                    const price = tour.pricePerPerson || 0;
                    html += `
                        <div class="col-md-3">
                            <div class="card">
                                <img src="${imageUrl}" class="card-img-top" alt="${tour.title}" height="150" style="object-fit: cover;">
                                <div class="card-body p-2">
                                    <h6 class="card-title small">${tour.title}</h6>
                                    <p class="text-primary fw-bold small mb-0">${price.toLocaleString()} VND</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            return html;
        }
    </script>
}
