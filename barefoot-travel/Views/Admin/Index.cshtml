@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Admin/_Layout.cshtml";
}

<!--  Row 1 -->
<div class="row">
  <div class="col-lg-8">
    <div class="card w-100">
      <div class="card-body">
        <div class="d-md-flex align-items-center">
          <div>
            <h4 class="card-title">Travel Bookings Overview</h4>
            <p class="card-subtitle">
              Monthly booking statistics and trends
            </p>
          </div>
          <div class="ms-auto">
            <ul class="list-unstyled mb-0">
              <li class="list-inline-item text-primary">
                <span class="round-8 text-bg-primary rounded-circle me-1 d-inline-block"></span>
                This Month
              </li>
              <li class="list-inline-item text-info">
                <span class="round-8 text-bg-info rounded-circle me-1 d-inline-block"></span>
                Last Month
              </li>
            </ul>
          </div>
        </div>
        <div id="sales-overview" class="mt-4 mx-n6"></div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card overflow-hidden">
      <div class="card-body pb-0 weekly-stats">
        <div class="d-flex align-items-start">
          <div>
            <h4 class="card-title">Weekly Stats</h4>
            <p class="card-subtitle">Average bookings</p>
          </div>
          <div class="ms-auto">
            <div class="dropdown">
              <a href="javascript:void(0)" class="text-muted" id="year1-dropdown" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="ti ti-dots fs-7"></i>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="year1-dropdown">
                <li>
                  <a class="dropdown-item" href="javascript:void(0)">View Details</a>
                </li>
                <li>
                  <a class="dropdown-item" href="javascript:void(0)">Export Data</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="mt-4 pb-3 d-flex align-items-center">
          <span class="btn btn-primary rounded-circle round-48 hstack justify-content-center">
            <i class="ti ti-calendar-check fs-6"></i>
          </span>
          <div class="ms-3">
            <h5 class="mb-0 fw-bolder fs-4">Top Bookings</h5>
            <span class="text-muted fs-3 top-bookings-name">Halong Bay Tour</span>
          </div>
          <div class="ms-auto">
            <span class="badge bg-secondary-subtle text-muted top-bookings-change">+25%</span>
          </div>
        </div>
        <div class="py-3 d-flex align-items-center">
          <span class="btn btn-warning rounded-circle round-48 hstack justify-content-center">
            <i class="ti ti-star fs-6"></i>
          </span>
          <div class="ms-3">
            <h5 class="mb-0 fw-bolder fs-4">Best Rated</h5>
            <span class="text-muted fs-3 best-rated-name">Sapa Trekking</span>
          </div>
          <div class="ms-auto">
            <span class="badge bg-secondary-subtle text-muted best-rated-rating">4.8★</span>
          </div>
        </div>
        <div class="py-3 d-flex align-items-center">
          <span class="btn btn-success rounded-circle round-48 hstack justify-content-center">
            <i class="ti ti-users fs-6"></i>
          </span>
          <div class="ms-3">
            <h5 class="mb-0 fw-bolder fs-4">Most Popular</h5>
            <span class="text-muted fs-3 most-popular-name">Hoi An Ancient Town</span>
          </div>
          <div class="ms-auto">
            <span class="badge bg-secondary-subtle text-muted most-popular-change">+45%</span>
          </div>
        </div>
        <div class="pt-3 mb-7 d-flex align-items-center">
          <span class="btn btn-secondary rounded-circle round-48 hstack justify-content-center">
            <i class="ti ti-currency-dollar fs-6"></i>
          </span>
          <div class="ms-3">
            <h5 class="mb-0 fw-bolder fs-4">Revenue</h5>
            <span class="text-muted fs-3 revenue-amount">$12,500</span>
          </div>
          <div class="ms-auto">
            <span class="badge bg-secondary-subtle text-muted revenue-change">+18%</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="col-12">
  <div class="card">
    <div class="card-body">
      <div class="d-md-flex align-items-center">
        <div>
          <h4 class="card-title">Recent Bookings</h4>
          <p class="card-subtitle">
            Latest tour bookings and status
          </p>
        </div>
        <div class="ms-auto mt-3 mt-md-0">
          <select class="form-select theme-select border-0" aria-label="Default select example">
            <option value="1">This Month</option>
            <option value="2">Last Month</option>
            <option value="3">This Year</option>
          </select>
        </div>
      </div>
      <div class="table-responsive mt-4">
        <table class="table mb-0 text-nowrap varient-table align-middle fs-3 recent-bookings-table">
          <thead>
            <tr>
              <th scope="col" class="px-0 text-muted">
                Customer
              </th>
              <th scope="col" class="px-0 text-muted">Tour</th>
              <th scope="col" class="px-0 text-muted">
                Status
              </th>
              <th scope="col" class="px-0 text-muted text-end">
                Amount
              </th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="px-0">
                <div class="d-flex align-items-center">

                  <div class="ms-3">
                    <h6 class="mb-0 fw-bolder">John Smith</h6>
                    <span class="text-muted">john@email.com</span>
                  </div>
                </div>
              </td>
              <td class="px-0">Halong Bay Cruise</td>
              <td class="px-0">
                <span class="badge bg-success">Confirmed</span>
              </td>
              <td class="px-0 text-dark fw-medium text-end">
                $299
              </td>
            </tr>
            <tr>
              <td class="px-0">
                <div class="d-flex align-items-center">

                  <div class="ms-3">
                    <h6 class="mb-0 fw-bolder">
                      Sarah Johnson
                    </h6>
                    <span class="text-muted">sarah@email.com</span>
                  </div>
                </div>
              </td>
              <td class="px-0">Sapa Trekking Tour</td>
              <td class="px-0">
                <span class="badge text-bg-warning">Pending</span>
              </td>
              <td class="px-0 text-dark fw-medium text-end">
                $189
              </td>
            </tr>
            <tr>
              <td class="px-0">
                <div class="d-flex align-items-center">

                  <div class="ms-3">
                    <h6 class="mb-0 fw-bolder">
                      Mike Wilson
                    </h6>
                    <span class="text-muted">mike@email.com</span>
                  </div>
                </div>
              </td>
              <td class="px-0">Hoi An Cultural Tour</td>
              <td class="px-0">
                <span class="badge bg-info">Processing</span>
              </td>
              <td class="px-0 text-dark fw-medium text-end">
                $159
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

@section Scripts {
<script>
  $(document).ready(function() {
    let chartInstance = null;

    // Load dashboard data
    function loadDashboardData(filterPeriod = null) {
      const url = filterPeriod 
        ? `${baseUrl}api/dashboard/stats?filterPeriod=${filterPeriod}`
        : `${baseUrl}api/dashboard/stats`;

      $.ajax({
        url: url,
        type: 'GET',
        success: function(response) {
          if (response.success && response.data) {
            updateMonthlyOverview(response.data.monthlyOverview);
            updateWeeklyStats(response.data.weeklyStats);
            updateRecentBookings(response.data.recentBookings);
          } else {
            console.error('Failed to load dashboard data:', response.message);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error loading dashboard data:', error);
        }
      });
    }

    // Update monthly overview chart
    function updateMonthlyOverview(data) {
      // Prepare chart data
      const categories = [];
      const thisMonthData = [];
      const lastMonthData = [];

      // Get all dates from both months
      const allDates = new Set([
        ...data.thisMonth.map(d => new Date(d.date).getDate()),
        ...data.lastMonth.map(d => new Date(d.date).getDate())
      ]);

      // Sort dates
      const sortedDates = Array.from(allDates).sort((a, b) => a - b);

      // Build chart data
      sortedDates.forEach(day => {
        categories.push(day);

        // Find data for this month
        const thisMonthPoint = data.thisMonth.find(d => new Date(d.date).getDate() === day);
        thisMonthData.push(thisMonthPoint ? thisMonthPoint.bookings : 0);

        // Find data for last month
        const lastMonthPoint = data.lastMonth.find(d => new Date(d.date).getDate() === day);
        lastMonthData.push(lastMonthPoint ? lastMonthPoint.bookings : 0);
      });

      // Calculate max value for y-axis
      const maxValue = Math.max(...thisMonthData, ...lastMonthData);
      const yMax = Math.ceil(maxValue * 1.2);

      // Create or update chart
      const chartOptions = {
        series: [
          {
            name: "This Month",
            data: thisMonthData,
          },
          {
            name: "Last Month",
            data: lastMonthData,
          },
        ],
        chart: {
          type: "bar",
          height: 275,
          toolbar: {
            show: false,
          },
          foreColor: "#adb0bb",
          fontFamily: "inherit",
          sparkline: {
            enabled: false,
          },
        },
        grid: {
          show: false,
          borderColor: "transparent",
          padding: {
            left: 0,
            right: 0,
            bottom: 0,
          },
        },
        plotOptions: {
          bar: {
            horizontal: false,
            columnWidth: "25%",
            endingShape: "rounded",
            borderRadius: 5,
          },
        },
        colors: ["var(--bs-primary)", "var(--bs-info)"],
        dataLabels: {
          enabled: false,
        },
        yaxis: {
          show: true,
          min: 0,
          max: yMax > 0 ? yMax : 10,
          tickAmount: 3,
        },
        stroke: {
          show: true,
          width: 5,
          lineCap: "butt",
          colors: ["transparent"],
        },
        xaxis: {
          type: "category",
          categories: categories,
          axisBorder: {
            show: false,
          },
        },
        fill: {
          opacity: 1,
        },
        tooltip: {
          theme: "dark",
        },
        legend: {
          show: false,
        },
      };

      // Destroy existing chart if any
      if (chartInstance) {
        chartInstance.destroy();
      }

      // Create new chart
      chartInstance = new ApexCharts(
        document.querySelector("#sales-overview"),
        chartOptions
      );
      chartInstance.render();
    }

    // Update weekly stats
    function updateWeeklyStats(data) {
      // Update Top Bookings
      if (data.topBookings) {
        $('.weekly-stats .top-bookings-name').text(data.topBookings.tourName);
        $('.weekly-stats .top-bookings-change').text(data.topBookings.changePercentage);
      } else {
        $('.weekly-stats .top-bookings-name').text('N/A');
        $('.weekly-stats .top-bookings-change').text('0%');
      }

      // Update Best Rated (if available)
      if (data.bestRated) {
        $('.weekly-stats .best-rated-name').text(data.bestRated.tourName);
        $('.weekly-stats .best-rated-rating').text(data.bestRated.rating.toFixed(1) + '★');
      } else {
        $('.weekly-stats .best-rated-name').text('N/A');
        $('.weekly-stats .best-rated-rating').text('N/A');
      }

      // Update Most Popular
      if (data.mostPopular) {
        $('.weekly-stats .most-popular-name').text(data.mostPopular.tourName);
        $('.weekly-stats .most-popular-change').text(data.mostPopular.changePercentage);
      } else {
        $('.weekly-stats .most-popular-name').text('N/A');
        $('.weekly-stats .most-popular-change').text('0%');
      }

      // Update Revenue
      if (data.revenue) {
        $('.weekly-stats .revenue-amount').text(formatCurrency(data.revenue.totalRevenue));
        $('.weekly-stats .revenue-change').text(data.revenue.changePercentage);
      }
    }

    // Update recent bookings table
    function updateRecentBookings(bookings) {
      const tbody = $('.recent-bookings-table tbody');
      tbody.empty();

      if (bookings && bookings.length > 0) {
        bookings.forEach(booking => {
          const row = `
            <tr>
              <td class="px-0">
                <div class="d-flex align-items-center">
                  <div class="ms-3">
                    <h6 class="mb-0 fw-bolder">${escapeHtml(booking.customerName)}</h6>
                    <span class="text-muted">${escapeHtml(booking.email)}</span>
                  </div>
                </div>
              </td>
              <td class="px-0">${escapeHtml(booking.tourName)}</td>
              <td class="px-0">
                <span class="badge ${booking.statusClass}">${escapeHtml(booking.status)}</span>
              </td>
              <td class="px-0 text-dark fw-medium text-end">
                ${formatCurrency(booking.amount)}
              </td>
            </tr>
          `;
          tbody.append(row);
        });
      } else {
        tbody.append(`
          <tr>
            <td colspan="4" class="text-center py-4 text-muted">
              No bookings found
            </td>
          </tr>
        `);
      }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Filter change handler
    $('.theme-select').on('change', function() {
      const filterPeriod = $(this).val();
      loadDashboardData(filterPeriod);
    });

    // Initial load
    loadDashboardData();
  });
</script>
}
